{
  "schemaVersion": "2.2",
  "description": "Update WAN2.1 service configuration on running EC2 instance",
  "parameters": {
    "apiKey": {
      "type": "String",
      "description": "API key for WAN2.1 service",
      "default": ""
    },
    "configSource": {
      "type": "String",
      "description": "Configuration source (s3, github, local)",
      "default": "s3",
      "allowedValues": ["s3", "github", "local"]
    },
    "s3Bucket": {
      "type": "String",
      "description": "S3 bucket name for configuration files",
      "default": ""
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "updateWAN21Config",
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "set -e",
          "",
          "# Configuration",
          "CONFIG_DIR=\"/opt/wan2-1-configs\"",
          "APP_DIR=\"/opt/wan2-1\"",
          "API_KEY=\"{{ apiKey }}\"",
          "CONFIG_SOURCE=\"{{ configSource }}\"",
          "S3_BUCKET=\"{{ s3Bucket }}\"",
          "",
          "# Logging function",
          "log() {",
          "    echo \"[$(date '+%Y-%m-%d %H:%M:%S')] $1\" | tee -a /var/log/wan2-1-update.log",
          "}",
          "",
          "log \"Starting WAN2.1 configuration update...\"",
          "",
          "# Stop the service",
          "log \"Stopping WAN2.1 service...\"",
          "systemctl stop wan2-1.service || true",
          "cd $APP_DIR",
          "docker-compose down || true",
          "",
          "# Update configuration files",
          "log \"Updating configuration files...\"",
          "",
          "# Download new configs from S3",
          "if [ \"$CONFIG_SOURCE\" = \"s3\" ] && [ -n \"$S3_BUCKET\" ]; then",
          "    log \"Downloading configuration files from S3...\"",
          "    aws s3 cp s3://$S3_BUCKET/configs/ $CONFIG_DIR/ --recursive",
          "fi",
          "",
          "# Verify configuration files exist",
          "if [ ! -f \"$CONFIG_DIR/wan2-1.env.template\" ] || [ ! -f \"$CONFIG_DIR/docker-compose.yml\" ]; then",
          "    log \"Configuration files not found, creating fallback...\"",
          "    mkdir -p $CONFIG_DIR",
          "    ",
          "    # Create fallback configs",
          "    cat > $CONFIG_DIR/wan2-1.env.template << 'ENVEOF'",
          "API_KEY=${api_key}",
          "API_HOST=0.0.0.0",
          "API_PORT=8002",
          "LOG_LEVEL=info",
          "MODEL_DEVICE=cuda",
          "MODEL_CACHE_DIR=/app/models",
          "ENVEOF",
          "fi",
          "",
          "# Process environment file template",
          "log \"Processing environment configuration...\"",
          "if command -v envsubst >/dev/null 2>&1; then",
          "    envsubst < $CONFIG_DIR/wan2-1.env.template > $APP_DIR/.env",
          "else",
          "    sed \"s/\\${api_key}/$API_KEY/g\" $CONFIG_DIR/wan2-1.env.template > $APP_DIR/.env",
          "fi",
          "",
          "# Copy configuration files",
          "log \"Copying configuration files...\"",
          "cp $CONFIG_DIR/docker-compose.yml $APP_DIR/",
          "cp $CONFIG_DIR/wan2-1.service /etc/systemd/system/wan2-1.service",
          "",
          "# Create required directories",
          "log \"Creating application directories...\"",
          "mkdir -p $APP_DIR/models $APP_DIR/outputs $APP_DIR/logs",
          "",
          "# Set proper permissions",
          "log \"Setting permissions...\"",
          "chown -R ubuntu:ubuntu $APP_DIR",
          "chmod +x /usr/local/bin/docker-compose",
          "",
          "# Reload systemd and restart service",
          "log \"Reloading systemd and restarting service...\"",
          "systemctl daemon-reload",
          "systemctl enable wan2-1.service",
          "systemctl start wan2-1.service",
          "",
          "# Verify service is running",
          "sleep 10",
          "if systemctl is-active --quiet wan2-1.service; then",
          "    log \"WAN2.1 service updated and started successfully\"",
          "else",
          "    log \"WARNING: WAN2.1 service may not have started properly\"",
          "    systemctl status wan2-1.service",
          "fi",
          "",
          "log \"Configuration update completed successfully\""
        ]
      }
    }
  ]
}
